---
- name: Set defaults
  set_fact:
    duration: "{{ iperf_duration | default(30) }}"
    sleep: "{{ iperf_sleep | default(5) }}"
    target_server: "{{ hostvars[groups['core_node'][0]].ip }}"
    core_ns: "{{ core }}"
    valid_ues: []
    ue_name: "{{ ue_name_map[ran] }}"
    tun_name: "{{ tun_name_map[ran] }}"
  vars:
    ue_name_map:
      oai: oai-nr-ue
      srsRAN: srsran-ue-srsue-ue
      ueransim: ueransim-ue
    tun_name_map:
      oai: oaitun_ue1
      srsRAN: tun_srsue
      ueransim: uesimtun0

- name: Get all pods in namespace
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ core_ns }}"
  register: all_pods

- name: Filter UE pods by name
  set_fact:
    ue_resources: "{{ all_pods.resources | selectattr('metadata.name', 'search', '^' + ue_name) | list }}"

- name: Force Install iperf3 (YUM then APT)
  shell: |
    kubectl exec -n {{ core_ns }} {{ item.metadata.name }} -- bash -c "
    if ! command -v iperf3 &> /dev/null; then
      if command -v yum &> /dev/null; then
        yum install -y -q iperf3 iproute
      elif command -v apt-get &> /dev/null; then
        apt-get update -qq && apt-get install -y -qq iperf3 iproute2
      else
        echo 'No package manager found' && exit 1
      fi
    fi
    command -v iperf3"
  loop: "{{ ue_resources }}"
  loop_control:
    label: "Installing iperf3 on {{ item.metadata.name }}"
  register: install_check
  failed_when: install_check.rc != 0

# following solve issues with iperf
- name: Configure UE MTU to 1350
  shell: |
    kubectl exec -n {{ core_ns }} {{ item.metadata.name }} -- \
    ip link set dev {{ tun_name }} mtu 1350
  loop: "{{ ue_resources }}"
  loop_control:
    label: "Setting MTU 1350 on {{ item.metadata.name }}"
  register: mtu_result
  failed_when: false

- name: Get tun IP
  shell: |
    kubectl exec -n {{ core_ns }} {{ item.metadata.name }} -- \
    /bin/bash -c "ip -4 addr show {{ tun_name }} | awk '/inet / {print \$2}' | cut -d/ -f1"
  loop: "{{ ue_resources }}"
  loop_control:
    label: "Getting IP for {{ item.metadata.name }}"
  register: ue_ip_results
  changed_when: false

- name: Init and Classify valid UEs
  set_fact:
    valid_ues: "{{ valid_ues + [ {'pod': item.item.metadata.name, 'ip': item.stdout | trim} ] }}"
  loop: "{{ ue_ip_results.results }}"
  # On change la condition pour être plus tolérant mais strict sur le contenu
  when: 
    - item.stdout is defined
    - item.stdout | trim | length > 0
    - item.stdout | trim != ""

- name: Init and Classify valid UEs
  set_fact:
    valid_ues: "{{ valid_ues + [ {'pod': item.item.metadata.name, 'ip': item.stdout | trim} ] }}"
  loop: "{{ ue_ip_results.results }}"
  loop_control:
    label: "{{ item.item.metadata.name }} -> {{ item.stdout | trim }}"
  when:
    - item.stdout is defined
    - item.stdout | trim is search('^[0-9.]+$')

- name: Add ip route to target_server
  shell: |
    kubectl exec -n {{ core_ns }} {{ item.metadata.name }} -- \
    ip route add {{ target_server }} via {{ item.ip.split('.')[:2] | join('.') }}.1.1
  loop: "{{ valid_ues }}"
  loop_control:
    label: "Setting route to iperf server on {{ item.metadata.name }}"
  register: route_result
  failed_when: false


- name: Show iperf uplink command
  debug:
    msg: >
      kubectl exec -n {{ core_ns }} {{ item.pod }} --
      iperf3 -B {{ item.ip }} -c {{ target_server }} -p {{ (5201 + idx | int) }} -t {{ duration | int }}
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "Uplink CMD: {{ item.pod }}"

- name: Run iperf uplink
  shell: >
    kubectl exec -n {{ core_ns }} {{ item.pod }} --
    iperf3 -B {{ item.ip }} -c {{ target_server }} -p {{ (5201 + idx | int) }} -t {{ duration | int }}
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "Uplink: {{ item.pod }} (Port: {{ 5201 + idx | int }})"
  register: iperf_results
  failed_when: false
  ignore_errors: yes

# wait 1s to prevent Bad file descriptor error
- pause:
    seconds: 1

- name: Wait for sockets to clear
  pause:
    seconds: "{{ sleep }}"

- name: Show iperf downlink command
  debug:
    msg: >
      kubectl exec -n {{ core_ns }} {{ item.pod }} --
      iperf3 -B {{ item.ip }} -c {{ target_server }} -p {{ (5201 + idx | int) }} -t {{ duration | int }} -R
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "Downlink CMD: {{ item.pod }}"

- name: Run iperf downlink
  shell: >
    kubectl exec -n {{ core_ns }} {{ item.pod }} --
    iperf3 -B {{ item.ip }} -c {{ target_server }} -p {{ (5201 + idx | int) }} -t {{ duration | int }} -R
  loop: "{{ valid_ues }}"
  loop_control:
    index_var: idx
    label: "Downlink: {{ item.pod }} (Port: {{ 5201 + idx | int }})"
  ignore_errors: yes
