---
- name: Deploy UERANSIM gNodeB using kubectl Kustomize
  ansible.builtin.shell: >
    kubectl apply -k {{ ueransim_root }}/ueransim-gnb -n {{ ran_ns | default('open5gs') }}
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"
  register: gnb_apply
  ignore_errors: false

- name: Patch gNB Deployment to run on ran_node
  kubernetes.core.k8s:
    state: patched
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: ueransim-gnb
        namespace: "{{ ran_ns | default('open5gs') }}"
      spec:
        template:
          spec:
            nodeSelector:
              kubernetes.io/hostname: "{{ ran_node_name }}"

- name: Wait for UERANSIM gNB pod to be ready
  community.kubernetes.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns | default('open5gs') }}"
    label_selectors:
      - "component=gnb"
  register: gnb_pods
  until: gnb_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 40
  delay: 5

- name: Verify that gNB service has active endpoints before deploying UEs
  ansible.builtin.shell: |
    endpoints=$(kubectl get endpoints gnb-service -n {{ ran_ns | default('open5gs') }} \
      -o jsonpath='{.subsets[0].addresses[*].ip}' 2>/dev/null)
    if [ -z "$endpoints" ]; then
      echo "ERROR: gNB service has no ready endpoints"
      exit 1
    else
      echo "gNB endpoints ready: $endpoints"
    fi
  register: gnb_check
  changed_when: false

- name: Deploy UERANSIM UEs using kubectl Kustomize
  ansible.builtin.shell: >
    kubectl apply -k {{ ueransim_root }}/ueransim-ue -n {{ ran_ns | default('open5gs') }}
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"
  register: ue_apply
  ignore_errors: false

- name: Patch UEs to run on ran_node
  kubernetes.core.k8s:
    state: patched
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        namespace: "{{ ran_ns | default('open5gs') }}"
      spec:
        template:
          spec:
            nodeSelector:
              kubernetes.io/hostname: "{{ ran_node_name }}"

- name: Wait for UERANSIM UE pods to be running
  community.kubernetes.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns | default('open5gs') }}"
    label_selectors:
      - "component=ue"
  register: ue_pods
  until: ue_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length >= 3
  retries: 60
  delay: 5
