---
- name: Apply UERANSIM gNB and UE base configurations
  ansible.builtin.shell: |
    kubectl apply -k {{ ueransim_root }}/ueransim-gnb -n {{ ran_ns | default('open5gs') }}
    kubectl apply -k {{ ueransim_root }}/ueransim-ue -n {{ ran_ns | default('open5gs') }}
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"

- name: Force all UEs to 0 replicas for sequential start
  ansible.builtin.shell: >
    kubectl scale deployment -n {{ ran_ns | default('open5gs') }} -l app=ueransim-ue --replicas=0
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"
  failed_when: false # Ignore if no deployments match yet

- name: Wait for gNB pod to be ready
  ansible.builtin.shell: >
    kubectl wait --for=condition=Ready pod -l app=ueransim-gnb -n {{ ran_ns | default('open5gs') }} --timeout=60s
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"

- name: Stability delay for gNB (10s)
  ansible.builtin.pause:
    seconds: 10

- name: Sequential deployment of UEs
  include_tasks: sequential_ue_deploy.yml
  loop: "{{ fiveg.ues | dict2items | selectattr('key', 'in', ['UE18', 'UE19', 'UE20']) | list }}"
  loop_control:
    loop_var: ue_item
    index_var: ue_idx
