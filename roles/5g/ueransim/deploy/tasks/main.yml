---
- name: Remove existing UERANSIM UEs for session cleanup
  ansible.builtin.shell: >
    kubectl delete -k {{ ueransim_root }}/ueransim-ue -n {{ ran_ns | default('open5gs') }} --ignore-not-found=true
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"

- name: Deploy UERANSIM gNodeB
  ansible.builtin.shell: >
    kubectl apply -k {{ ueransim_root }}/ueransim-gnb -n {{ ran_ns | default('open5gs') }}
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"

- name: Wait for gNB pod to be Running
  community.kubernetes.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns | default('open5gs') }}"
    label_selectors:
      - "component=gnb"
  register: gnb_pods
  until: gnb_pods.resources | selectattr('status.phase','equalto','Running') | list | length > 0
  retries: 20
  delay: 5

- name: Delay for gNB stability (NGAP/SCTP)
  ansible.builtin.pause:
    seconds: 10

- name: Sequential deployment of UEs
  # We use the list of UEs defined in your variables to be dynamic
  include_tasks: sequential_ue_deploy.yml
  loop: "{{ fiveg.ues | dict2items | selectattr('key', 'in', ['UE18', 'UE19', 'UE20']) | list }}"
  loop_control:
    loop_var: ue_item
    index_var: ue_idx
