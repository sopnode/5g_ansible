---
- name: Apply UERANSIM UE base configuration (Kustomize)
  ansible.builtin.shell: >
    kubectl apply -k {{ ueransim_root }}/ueransim-ue -n {{ ran_ns | default('open5gs') }}
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"

- name: Ensure all UEs are scaled down for sequential start
  ansible.builtin.shell: >
    kubectl scale deployment -l component=ue --replicas=0 -n {{ ran_ns | default('open5gs') }}
  environment:
    KUBECONFIG: "{{ kubeconfig | default('/root/.kube/config') }}"

- name: Wait for gNB pod to be Running
  community.kubernetes.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns | default('open5gs') }}"
    label_selectors:
      - "component=gnb"
  register: gnb_pods
  until: gnb_pods.resources | selectattr('status.phase','equalto','Running') | list | length > 0
  retries: 20
  delay: 5

- name: Stability delay for gNB (10s)
  ansible.builtin.pause:
    seconds: 10

- name: Sequential deployment of UEs
  include_tasks: sequential_ue_deploy.yml
  loop: "{{ fiveg.ues | dict2items | selectattr('key', 'in', ['UE18', 'UE19', 'UE20']) | list }}"
  loop_control:
    loop_var: ue_item
    index_var: ue_idx
    label: "Activating {{ ue_item.key }} as ueransim-ue{{ ue_idx + 1 }}"
