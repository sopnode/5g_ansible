---
- name: Deploy gNB using kustomize on ran_node
  ansible.builtin.command: >
    kubectl apply -k {{ ueransim_root }}/ueransim-gnb
    -n {{ ran_ns | default('open5gs') }}
  environment:
    KUBE_NODE_SELECTOR: "kubernetes.io/hostname={{ ran_node_name }}"
  register: gnb_apply
  changed_when: "'configured' in gnb_apply.stdout or 'created' in gnb_apply.stdout"

- name: Wait for gNB pod to be ready
  community.kubernetes.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns | default('open5gs') }}"
    label_selectors:
      - "component=gnb"
  register: gnb_pods
  retries: 12
  delay: 5
  until: gnb_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0

- name: Deploy UEs using kustomize on ran_node
  ansible.builtin.command: >
    kubectl apply -k {{ ueransim_root }}/ueransim-ue
    -n {{ ran_ns | default('open5gs') }}
  environment:
    KUBE_NODE_SELECTOR: "kubernetes.io/hostname={{ ran_node_name }}"
  register: ue_apply
  changed_when: "'configured' in ue_apply.stdout or 'created' in ue_apply.stdout"

- name: Wait for UE pods to be running
  community.kubernetes.k8s_info:
    kind: Pod
    namespace: "{{ ran_ns | default('open5gs') }}"
    label_selectors:
      - "component=ue"
  register: ue_pods
  retries: 12
  delay: 5
  until: ue_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == 3
