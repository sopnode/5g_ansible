---

- name: Check if yq is already installed
  ansible.builtin.stat:
    path: "{{ yq_bin_path }}"
  register: yq_bin

- name: Download yq binary using curl or wget
  ansible.builtin.shell: |
    set -e
    if command -v curl >/dev/null 2>&1; then
      curl -L --fail "{{ yq_url }}" -o "{{ yq_bin_path }}"
    elif command -v wget >/dev/null 2>&1; then
      wget -O "{{ yq_bin_path }}" "{{ yq_url }}"
    else
      echo "Neither curl nor wget found" >&2
      exit 1
    fi
  args:
    creates: "{{ yq_bin_path }}"
  when: not yq_bin.stat.exists
  become: true

- name: Ensure yq is executable
  ansible.builtin.file:
    path: "{{ yq_bin_path }}"
    mode: '0755'
    state: file
  become: true


- name: Load active 5G profile
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/all/5g_profile_{{ fiveg_profile | default('default') }}.yaml"
    name: fiveg

- name: Validate PLMN
  assert:
    that:
      - fiveg.plmn.mcc is defined
      - fiveg.plmn.mnc is defined
      - fiveg.plmn.tac is defined

- name: Validate slices
  assert:
    that:
      - slice.name is defined
      - slice.sst is defined
      - slice.dnn is defined
  loop: "{{ fiveg.slices }}"
  loop_control:
    loop_var: slice

- name: Validate UE slice references
  assert:
    that:
      - ue.value.slice in fiveg.slices | map(attribute='name') | list
  loop: "{{ fiveg.ues | dict2items }}"
  loop_control:
    loop_var: ue

- name: Initialize ueransim_slices list
  set_fact:
    ueransim_slices: []

- name: Map slices for UERANSIM
  set_fact:
    ueransim_slices: "{{ ueransim_slices + [ {'sst': sl_item.sst | int, 'sd': lookup('template', 'slice_sd.j2') | trim} ] }}"
  loop: "{{ fiveg.slices }}"
  loop_control:
    loop_var: sl_item

- name: Update UERANSIM gNB configuration
  ansible.builtin.shell: >
    {{ yq_bin_path }} eval -i '
      .mcc = "{{ fiveg.plmn.mcc }}" |
      .mnc = "{{ fiveg.plmn.mnc }}" |
      .tac = {{ fiveg.plmn.tac | int }} |
      .linkIp = "0.0.0.0" |
      .ngapIp = "10.10.3.231" |
      .gtpIp = "10.10.3.231" |
      .slices = {{ ueransim_slices | to_json }}
    ' "{{ ueransim_root }}/ueransim-gnb/config/open5gs-gnb.yaml"

- name: Rewrite UERANSIM configs
  ansible.builtin.copy:
    dest: "{{ ueransim_root }}/ueransim-ue/ue{{ ue_num }}/ue{{ ue_num }}.yaml"
    content: |
      supi: imsi-{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}{{ item.value.imsi_suffix }}
      mcc: '{{ fiveg.plmn.mcc }}'
      mnc: '{{ fiveg.plmn.mnc }}'
      key: 'fec86ba6eb707ed08905757b1bb44b8f'
      op: 'C42449363BBAD02B66D16BC975D77CC1'
      opType: 'OPC'
      amf: '8000'
      imei: '356938035643803'
      imeiSv: '4370816125816151'
      gnbSearchList:
        - gnb-service
      uacAic:
        mps: false
        mcs: false
      uacAcc:
        normalClass: 0
        class11: false
        class12: false
        class13: false
        class14: false
        class15: false
      sessions:
        - type: 'IPv4'
          apn: '{{ curr_slice.dnn }}'
          slice:
            sst: 1
            sd: {{ '0xFFFFFF' if curr_slice.sd == 'EMPTY' else ('0x' + curr_slice.sd if '0x' not in curr_slice.sd|string else curr_slice.sd) }}
      configured-nssai:
        - sst: 1
          sd: {{ '0xFFFFFF' if curr_slice.sd == 'EMPTY' else ('0x' + curr_slice.sd if '0x' not in curr_slice.sd|string else curr_slice.sd) }}
      default-nssai:
        - sst: 1
          sd: {{ '0xFFFFFF' if curr_slice.sd == 'EMPTY' else ('0x' + curr_slice.sd if '0x' not in curr_slice.sd|string else curr_slice.sd) }}
      integrity:
        IA1: true
        IA2: true
        IA3: true
      ciphering:
        EA1: true
        EA2: true
        EA3: true
      integrityMaxRate:
        uplink: 'full'
        downlink: 'full'
  vars:
    curr_slice: "{{ fiveg.slices | selectattr('name', 'equalto', item.value.slice) | first }}"
    ue_num: "{{ '1' if item.key == 'UE18' else '2' if item.key == 'UE19' else '3' }}"
  loop: "{{ fiveg.ues | dict2items | selectattr('key', 'in', ['UE18', 'UE19', 'UE20']) | list }}"

- name: Replicas to 0
  ansible.builtin.shell: >
    {{ yq_bin_path }} eval -i '.spec.replicas = 0' "{{ ueransim_root }}/ueransim-ue/ue{{ item }}/ue-deployment.yaml"
  loop: [1, 2, 3]
