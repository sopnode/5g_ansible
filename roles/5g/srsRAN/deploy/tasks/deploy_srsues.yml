---
# ------------------------------
# Deploy srsRAN UEs (multi-pod, RFSIM only)
# Minimal changes, safe for USRP mode
# ------------------------------

# Build the list of UEs to deploy from the 5G profile
- name: Build UE list from 5G profile (UE18/19/20)
  set_fact:
    ue_list:
      - name: ue1
        imsi: "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}{{ fiveg.ues.UE18.imsi_suffix }}"
        dnn: "{{ fiveg.slices | selectattr('name','equalto',fiveg.ues.UE18.slice) | map(attribute='dnn') | first }}"
        tx_port: 2100
        rx_port: 2000

      - name: ue2
        imsi: "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}{{ fiveg.ues.UE19.imsi_suffix }}"
        dnn: "{{ fiveg.slices | selectattr('name','equalto',fiveg.ues.UE19.slice) | map(attribute='dnn') | first }}"
        tx_port: 2200
        rx_port: 2001

      - name: ue3
        imsi: "{{ fiveg.plmn.mcc }}{{ fiveg.plmn.mnc }}{{ fiveg.ues.UE20.imsi_suffix }}"
        dnn: "{{ fiveg.slices | selectattr('name','equalto',fiveg.ues.UE20.slice) | map(attribute='dnn') | first }}"
        tx_port: 2300
        rx_port: 2002

# Debug the list of UEs before deployment
- name: Debug UE list
  ansible.builtin.debug:
    msg: "{{ ue_list }}"

- name: Clean old ConfigMap for this UE release
  when: rru == "rfsim"
  kubernetes.core.k8s:
    api_version: v1
    kind: ConfigMap
    namespace: "{{ ran_ns }}"
    name: "srsran-ue-{{ item.name }}-ue-config"
    state: absent
  loop: "{{ ue_list }}"
  loop_control:
    loop_var: item

# Deploy each UE as a separate Helm release
- name: Deploy each srsUE pod as separate Helm release
  when: rru == "rfsim"
  kubernetes.core.helm:
    name: "srsue-{{ item.name }}"           # Unique release name per UE
    chart_ref: "{{ [repo_dest_abs, 'charts', 'srsue'] | path_join }}" # Path to srsUE Helm chart
    release_namespace: "{{ ran_ns }}"       # Deployment namespace
    state: present                          # Ensure the release is installed
    wait: true                              # Wait for pod readiness
    values:                                 # Specific values for this UE
      imsi: "{{ item.imsi }}"               # IMSI from profile
      k: "{{ fiveg.security.full_key }}"    # UE K key
      opc: "{{ fiveg.security.opc }}"       # UE OPC
      apn: "{{ item.dnn }}"                 # DNN slice
      zmq:
        tx_port: "{{ item.tx_port }}"       # Unique TX port for this UE
        rx_port: "{{ item.rx_port }}"       # RX port on gNB (can be shared)
  loop: "{{ ue_list }}"
